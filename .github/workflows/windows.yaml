name: Build and Release CPU/GPU Miner - Windows

on:
  push:
    branches:
      - windows

concurrency:
    group: ${{ github.repository }}-${{ github.event.ref }}
    cancel-in-progress: true

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up CUDA
      uses: Jimver/cuda-toolkit@v0.2.11
      id: cuda-toolkit
      with:
          cuda: 11.8.0

    - name: Create build directory
      run: mkdir build
      working-directory: ${{ github.workspace }}

    - name: Configure CMake
      run: |
        cd src/build
        cmake ..
      working-directory: ${{ github.workspace }}

    - name: Build CUDA code
      run: |
        cd src/build
        make -j N
        Compress-Archive -Path ./3dp-miner.exe -Destination ./3dp-miner_windows.zip
      working-directory: ${{ github.workspace }}

    
    - name: Create Release
      uses: ncipollo/release-action@v1.13.0
      with:
        artifacts: |
          src/build/3dp-miner_windows.zip
        draft: true
        prerelease: false
        skipIfReleaseExists: false
        artifactErrorsFailBuild: true
        tag: latest-windows
